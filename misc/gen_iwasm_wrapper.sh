#!/bin/bash
# Generates the default iwasm-wrapper script required by binfmt_register.sh

SCRIPT_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )
source $SCRIPT_DIR/../toolchains/wali.sh

# Save default environment variables in ".walienv" in root WALI dir
env &> $WALI_ROOT_DIR/.walienv

# Write wrapper script ("iwasm-wrapper") with default settings
# Modify default settings as needed
cat <<EOT > $SCRIPT_DIR/iwasm-wrapper
#!/bin/bash
### Generated by "binfmt_register.sh" in WALI
### Wrapper for running WASM programs by pointing to built iwasm in root WALI dir 

WL_VERBOSITY=\${WALI_VERBOSE:-0}
if [ -z "\${WALI_STRACE}" ]; then
    STRACE_ARG=""
elif [[ "\${WALI_STRACE}" =~ ^-?[0-9]+$ ]]; then
    STRACE_ARG="--strace"
else
    STRACE_ARG="--strace=\${WALI_STRACE}"
fi

if [ -z "\${WALI_ENVFILE}" ]; then
    WL_ENVFILE="$WALI_ROOT_DIR/.walienv"
else
    WL_ENVFILE=\$WALI_ENVFILE
fi

exec $WALI_ROOT_DIR/iwasm -v=\$WL_VERBOSITY \$STRACE_ARG --stack-size=4194304 --max-threads=100 --env-file=\$WL_ENVFILE "\$@"
EOT
if [ $? -ne 0 ]; then
  echo "Error writing iwasm-wrapper"
  exit 1
fi
echo "Successfully generated iwasm-wrapper"
chmod +x iwasm-wrapper

# Generate the iwali
cat <<EOT > $SCRIPT_DIR/iwali.conf
### Generated by "binfmt_register.sh" in WALI
### Binfmt.d configuration settings for iwasm interpreter 
:wali-interp:M::\x00asm::$SCRIPT_DIR/iwasm-wrapper:
:wali-aot:M::\x00aot::$SCRIPT_DIR/iwasm-wrapper:
EOT
if [ $? -ne 0 ]; then
  echo "Error writing iwali-conf"
  exit 1
fi
echo "Successfully generated iwali-conf"

